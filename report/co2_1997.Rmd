---
title: "Global $CO_{2}$ Emissions in 1997"
short: "What Keeling missed all these years"
journal: "AER" # AER, AEJ, PP, JEL
month: "`r format(Sys.Date(), '%m')`"
year: "`r format(Sys.Date(), '%Y')`"
vol: 0
issue: 0
keywords:
  - Replication
  - Modern Science
author:
  - name: Majid Maki-Nayeri
    firstname: Maki-Nayeri
    surname: Maki-Nayeri
    email: m_maki@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
  - name: Vinod Bakthavachalam
    firstname: Vinod
    surname: Bakthavachalam
    email: vinodb@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
  - name: Artem Lebedev
    firstname: Artem 
    surname: Lebedev
    email: artem.lebedev@berkeley.edu
    affiliation: McMaster University, Department of Chemistry and Biochemistry
acknowledgements: | 
  The authors would like to thank their instructors from MIDS 271.
abstract: | 
  The year is 1997 and global attention is turning toward the consequences of human-actions in our environmental system. The IPCC has been in existence and studying these trends for more than ten years, and has released its second assessment report in 1995. In this report, the IPCC notes that the balance of the evidence suggests that human-actions play a role in the changing climate. Although, there is little political will to change this activity, neither have global progressive and conservative politicians broken into clear partisan camps. Here, we assess data from the Mona Loa observatory to describe and predict global $CO_{2}$ concentrations under several possible scenarios. What we find, when we run the analysis, is going to be grim.
header-includes: 
  - '\usepackage{graphicx}'
  - '\usepackage{booktabs}'
  - '\usepackage{wrapfig}'
  - '\usepackage{subcaption}'
output: rticles::aea_article
---

```{r setup, echo=FALSE}
## default to not show code, unless we ask for it.
knitr::opts_chunk$set(echo=FALSE, warning = FALSE, dpi=600)
options(digits = 3)
```


```{r load packages, echo = FALSE, message = FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
library(dplyr)
library(magrittr)
library(patchwork)
library(lubridate)
library(feasts)
library(forecast)
library(sandwich)
if (!"fable" %in% rownames(installed.packages())) {
  install.packages("fable")
}
library(fable)
if (!"car" %in% rownames(installed.packages())) {
  install.packages("car")
}
library(car)
theme_set(theme_minimal())
```

# Introduction

This report aims to elucidate trends in the atmospheric $CO_2$ concentration, a question that has recieved considerable attention in the recent year. 
 At this time the data seem to show an alarming trend of increasing  levels year over year. This is alarming because $CO_2$ contributes to the "greenhouse effect", where certain gasses collect in the Earth's atmosphere and trap heat from leaving the Earth. As $CO_2$ levels increase we expect the Earth's temperature to increase with it. While the exact effects of the change this will have on the Earth's environment remain to be seen, expected changes include but are not limited to the following:
- Heat waves
- Drought
- Rising sea levels
With the data at hand, it is imperative that we discover whether we have enough evidence to show that this recent rise in $CO_2$ levels is the result of a larger trend or could be explained by natural variation. If this trend is confirmed then it could pave the way to future research on ways to measure and address the adverse effects and causes of this rise in $CO_2$. This report will look into the existence of this larger trend of rising $CO_2$ levels and, if it exists, will also report on the magnitude of the rise as well as project future $CO_2$ levels.

## Carbon Emissions 
\textcolor{red}{What are are carbon emissions, and why should anyone care about them? Briefly review what is known about the relationship between the burning of fossil fuels, atmospheric $CO_{2}$}
\textcolor{red}{What is the current understanding of the linkage between atmospheric $CO_{2}$ and global average temperatures.}

# Atmospheric $CO_{2}$ Measurement and Data 

The data we will be using for this analysis is the $CO_2$ measurements from a laboratory at Mauna Loa, Hawaii. While there are other laboratories that collect $CO_2$ measurements, the Mauna Loa site has been collected $CO_2$ longer than any other site in the world which will give us the most data to work with as we conduct this analysis. The Mauna Loa site is also unique in that it is representative of air for the entire Northern Hemisphere due to its altitude and is not usually affected by nearby vegetation as the site is surrounded be lava flows.

The Mauna Loa data is frequently used because of the amount *and* quality of the data collected. Specifically, this dataset contains accurate and robust measurements of the number of $CO_2$ molecules per million in a cubic meter of *dry* air. The term **concentration** may be used for familiarity but it should be stated that this is not the preferred term as the concentration of $CO_2$ may be affected be a number of factors unrelated to how much $CO_2$ is actually in the world's atmosphere at a given moment.

This site measures the concentration of $CO_2$ by funneling air through a cold chamber (to eliminate the effect of humidity) and then measuring how much infrared radiation is absorbed by the $CO_2$ in the chamber. Because $CO_2$ naturally absorbs infrared radiation, a higher density of $CO_2$ molecules will absorb more radiation. The researchers at the Mauna Loa site take great care to continually calibrate their equipment multiple times a day. In addition, the researchers are careful to account for any outside factors that may effect measurements such as the diurnal wind flow patterns present on Mauna Loa. Altogether, we can be confident that the data recorded at Mauna Loa is representative of global $CO_2$ concentrations.

```{r load the data}
co2_ts <- tsibble::as_tsibble(co2)

co2_df <- data.frame(index = 1:nrow(co2_ts),
                     month = factor(month(co2_ts$index)),
                     value = co2_ts$value)
```

```{r plot the keeling curve, echo = FALSE}
fig_1 <- co2_ts %>%
  ggplot() + 
  aes(x=index, y= value) + 
  geom_line(color = 'steelblue') +
  labs(
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  ) + theme(axis.text.x=element_text(size=10), 
            axis.text.y=element_text(size=10), 
           axis.title.x=element_text(size=20),
           axis.title.y=element_text(size=20),
            )

ggsave(filename = './figures/plot_original_ts.png', plot = fig_1, device = "png", units = c("in"), height=5, width=10)
```

# Exploratory analysis of historical trends in atmospheric $CO_{2}$
\begingroup
\setlength{\intextsep}{12pt}
\setlength{\columnsep}{12pt}
\begin{wrapfigure}[17]{l}{0.5\textwidth}
    \centering\includegraphics[width=1\linewidth]{./figures/plot_original_ts.png}
    \caption{Historic trend in monthly mean [$CO_2$]\label{fig:carbon}}
    \begin{figurenotes}
      $CO_2$ concentration exhibits accelerating growth, with strong seasonal oscillations. These patterns point to the need of de-seasoning and de-trending before further analysis.
    \end{figurenotes}
\end{wrapfigure}
\par
\textcolor{red}{Description how, where and why the data is generated}
\par
\textcolor{red}{Investigate the trend, seasonal and irregular elements. Trends both in levels and growth rates should be discussed}
\par
\textcolor{blue}{Atmospheric carbon is plotted in \autoref{fig:carbon}, and shows some worrying trends. Just look at how wobbly that line is. How is it possible that we are not living in a simulation, when the lines that plots monthly average $CO_{2}$ looks like this?}
\par
\endgroup

# Models and Forecasts 
\textcolor{blue}{While these plots might be compelling, it is often challenging to learn the exact nature of a time serires process from only these overview, "time vs. outcome" style of plots. In this section, we present evaluate two classes models to assess which time series model is most appropriate to use. }

## Linear and Polynomial models 

\textcolor{red}{Discuss whether a logarithmic transformation of the data would be appropriate. Fit a polynomial time trend model that incorporates seasonal dummy variables, and use this model to generate forecasts to the year 2020.}

\begin{equation}
\label{eq:one}
\text{CO}_{2} = \phi_{0} + \phi_{1}t + \phi_{2}t^2 + \epsilon_{eit}
\end{equation} 

This is a general form of a polynomial model, where $CO_{2}$ concentration is modeled as a polynomial  function of time and a random error.
\par
We first estimate the linear model, which is a variant of \autoref{eq:one} with $\phi_{2}=0$:  

```{r estimate a linear model, echo=TRUE}
model_lin <- lm(formula = value ~ index, data = co2_df)
```

```{r plot linear model}
lin_plot <- co2_df %>%
ggplot() + aes(x = index, y = value) +
  geom_point(color = "steelblue") +
  geom_line(aes(y = fitted(model_lin)), color = "red", size = 2) +
  labs(x = 'Month and Year', y = TeX(r'($CO_2$ parts per million)')) +
  theme(axis.text.x=element_text(size=20), 
        axis.text.y=element_text(size=20), 
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20),
        )

ggsave(filename = './figures/plot_lin_model.png', plot = lin_plot, device = "png", units = c("in"), height= 4, width=5)
```

```{r linear model residuals, results='hide', echo=FALSE}
png(file = './figures/plot_lin_mod_resid.png', height=4, width=5, units = c("in"), res = 600)
checkresiduals(model_lin, test=FALSE, plot = TRUE)
dev.off()
```
\begin{figure}[htbp]
  \centering
  \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=\textwidth]{./figures/plot_lin_model.png}
    \caption{Linear model and the underlying data for [$CO_2$] \label{fig:lin_model}}
  \end{subfigure}
  \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=\textwidth]{./figures/plot_lin_mod_resid.png}
    \caption{Diagnostic plots for residuals of the linear model\label{fig:lin_model_resid}}
  \end{subfigure}
  \caption{Linear model\label{fig:lin_mods}}
\end{figure}


While the residuals do appear to follow a normal distribution, it is clear that a purely linear model does a poor job at modeling the seasonality of the data. There is also still clearly a trend in the remaining residuals which a linear model fails to capture. Overall, the a linear model does capture some of the trend but would not be sufficient to eliminate it entirely.

```{r quadratic model}
model.quadratic <- lm(formula = value ~ index + I(index^2), data = co2_df)
```

```{r plot quadratic model}
quad_plot <- co2_df %>%
ggplot() + aes(x = index, y = value) +
  geom_point(color = "steelblue") +
  geom_line(aes(y = fitted(model.quadratic)), color = "red", size = 2) +
  labs(x = 'Month and Year', y = TeX(r'($CO_2$ parts per million)')) +
  theme(axis.text.x=element_text(size=20), 
        axis.text.y=element_text(size=20), 
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20),
        )

ggsave(filename = './figures/plot_quad_model.png', plot = quad_plot, device = "png", units = c("in"), height= 4, width=5)
```

```{r residuals fro quad model, results='hide', echo=FALSE}
png(file = './figures/plot_quad_mod_resid.png', height=4, width=5, units = c("in"), res = 600)
checkresiduals(model.quadratic, test=FALSE, plot = TRUE)
dev.off()
```


\begin{figure}[htbp]
  \centering
  \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=\textwidth]{./figures/plot_quad_model.png}
    \caption{Quadratic model and the underlying data for [$CO_2$] \label{fig:quad_model}}
  \end{subfigure}
  \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=\textwidth]{./figures/plot_quad_mod_resid.png}
    \caption{Diagnostic plots for residuals of the quadratic model\label{fig:quad_model_resid}}
  \end{subfigure}
  \caption{Linear model\label{fig:quad_mods}}
\end{figure}
A quadratic model fares slightly better than a linear model. It captures inherent non-linearity of the trend ( \autoref{fig:quad_model}), but fails to capture seasonality. Diagnostic plots for this model ( \autoref{fig:quad_model_resid}) show that residuals are not normally distributed and ACF plot shows strong osculations.

## ARIMA times series model

\textcolor{red}{Following all appropriate steps, choose an ARIMA model to fit to the series. Discuss the characteristics of your model and how you selected between alternative ARIMA specifications. Use your model (or models) to generate forecasts to the year 2022. }

```{r Split into test and train, echo = TRUE}
my_lag <- 12
co2_ts <- mutate(co2_ts, deseasoned = difference(value, lag = my_lag))
co2_ts <- mutate(co2_ts, detrended = difference(deseasoned, lag = 1))
co2_ts <- slice(co2_ts, my_lag + 2:nrow(co2_ts))
```

```{r Explore model space}
# Generate a set of models AR(1)-AR(10) and MA(1)-MA(10)
# with first and second degree of differencing.
# Select the model with the lowest BIC

model.bic <- co2_ts %>%
  model(ARIMA(deseasoned ~ 1 + pdq(1:10, 1:2, 1:10) + PDQ(0, 0, 0),
    ic = "bic",
    stepwise = F, greedy = F
  ))

# Report the winning model parameters
model.bic %>% report()
```

```{r Make final model}
hist_arima <- arima(co2_ts$value,
  order = c(1, 1, 1),
  seasonal = list(order = c(0, 1, 1), period = 12)
)
hist_arima
```

```{r forecast to 2022}
frcst_length <- 300
frcst_2022 <- forecast(hist_arima, h=frcst_length)
```


```{r forecast plotting, results='hide'}
futuredate <- seq(ISOdate(1998,01,01), by = "month", length.out = frcst_length)

df_toPlot <- cbind.data.frame(futuredate, frcst_2022$mean, frcst_2022$lower, frcst_2022$upper)
df_toPlot$week <- yearweek(df_toPlot$futuredate)

df_toPlot <- df_toPlot[c(2,4,6,7)]
names(df_toPlot) <- c("mean", "lower", "upper", "date")

forecast_plot <- df_toPlot %>% ggplot() + 
  aes(x = date, y = mean) +
  geom_line(color = "red") + 
  geom_ribbon(aes(ymin=lower,ymax=upper), fill="yellow", alpha=0.35)

ggsave(filename = "./figures/plot1_frcst2022.pdf", plot = forecast_plot, device = "pdf", units = c("in"), height = 4, width = 10)
```


\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot1_frcst2022.pdf}
  \caption{Forecast for future CO2 concentration \label{fig:frcst2y}}
  \begin{figurenotes}
    Residuals appear to be white noise
  \end{figurenotes}
\end{figure}

## Forecast atmospheric $CO_{2}$ growth

\textcolor{red}{Generate predictions for when atmospheric CO2 is expected to be at 420 ppm and 500 ppm levels for the first and final times (consider prediction intervals as well as point estimates in your answer). Generate a prediction for atmospheric CO2 levels in the year 2100. How confident are you that these will be accurate predictions?}

# Conclusions 

\textcolor{red}{What to conclude is unclear. }

\bibliographystyle{aea}
\bibliography{references}

\appendix
\section{Appendix: Model Robustness}

\textcolor{red}{While the most plausible model that we estimate is reported in the main, "Modeling" section, in this appendix to the article we examine alternative models. Here, our intent is to provide a skeptic that does not accept our assessment of this model as an ARIMA of order (1,2,3) an understanding of model forecasts under alternative scenarios. }
