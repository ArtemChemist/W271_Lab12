---
title: "Global $CO_{2}$ Emissions in 1997"
short: "What Keeling missed all these years"
journal: "AER" # AER, AEJ, PP, JEL
month: "`r format(Sys.Date(), '%m')`"
year: "`r format(Sys.Date(), '%Y')`"
vol: 0
issue: 0
author:
  - name: Sean Seneviratne
    firstname: Sean
    surname: Seneviratne
    email: sean_senev@ischool.berkeley.edu
    affiliation: UC Berkeley
  - name: Trevor Dalton
    firstname: Trevor
    surname: Dalton
    email: trevor.dalton@ischool.berkeley.edu
    affiliation: UC Berkeley
  - name: Kyle Ruan
    firstname: Kyle
    surname: Ruan
    email: kyleruan@ischool.berkeley.edu
    affiliation: UC Berkeley
  - name: Artem Lebedev
    firstname: Artem 
    surname: Lebedev
    email: artem.lebedev@berkeley.edu
    affiliation: McMaster University
abstract: | 
  In this report we assess data from the Mona Loa observatory to model and predict atmospheric $CO_{2}$ concentrations. Assuming all forces that currently influence atmospheric carbon remain unchanged, our model predicts a grim future for the global climate.
header-includes: 
  - '\usepackage{graphicx}'
  - '\usepackage{booktabs}'
  - '\usepackage{wrapfig}'
  - '\usepackage{subcaption}'
output: rticles::aea_article
---

```{r setup, echo=FALSE}
## default to not show code, unless we ask for it.
knitr::opts_chunk$set(echo=FALSE, warning = FALSE, dpi=600)
options(digits = 3)
```


```{r load packages, echo = FALSE, message = FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
library(dplyr)
library(magrittr)
library(patchwork)
library(lubridate)
library(feasts)
library(forecast)
library(sandwich)
if (!"fable" %in% rownames(installed.packages())) {
  install.packages("fable")
}
library(fable)
if (!"car" %in% rownames(installed.packages())) {
  install.packages("car")
}
library(car)
theme_set(theme_minimal())
```

# Introduction

This report aims to elucidate trends in the atmospheric $CO_2$ concentration, a question that has recieved considerable attention in the recent year. At this time the data seem to show an alarming trend of increasing  levels year over year. This is alarming because $CO_2$ contributes to the "greenhouse effect", where certain gasses collect in the Earth's atmosphere and trap heat from leaving the Earth. As $CO_2$ levels increase we expect the Earth's temperature to increase leading to heat waves, drought and rising sea levels. \hfill\break\indent With the data at hand, it is imperative that we discover whether we have enough evidence to show that this recent rise in $CO_2$ levels is the result of a larger trend or could be explained by natural variation. If this trend is confirmed then it could pave the way to future research on ways to measure and address the adverse effects and causes of this rise in $CO_2$. This report will look into the existence of this larger trend of rising $CO_2$ levels and, if it exists, will also report on the magnitude of the rise as well as project future $CO_2$ levels.

## Carbon Emissions 
\textcolor{red}{What are are carbon emissions, and why should anyone care about them? Briefly review what is known about the relationship between the burning of fossil fuels, atmospheric $CO_{2}$}
\textcolor{red}{What is the current understanding of the linkage between atmospheric $CO_{2}$ and global average temperatures.}

# Atmospheric $CO_{2}$ Measurement and Data 

The data we will be using for this analysis is the $CO_2$ measurements from a laboratory at Mauna Loa, Hawaii. While there are other laboratories that collect $CO_2$ measurements, the Mauna Loa site has been collected $CO_2$ longer than any other site in the world which will give us the most data to work with as we conduct this analysis. The Mauna Loa site is also unique in that it is representative of air for the entire Northern Hemisphere due to its altitude and is not usually affected by nearby vegetation as the site is surrounded be lava flows. \hfill\break\indent The Mauna Loa data is frequently used because of the amount *and* quality of the data collected. Specifically, this dataset contains accurate and robust measurements of the number of $CO_2$ molecules per million in a cubic meter of *dry* air.
\hfill\break\indent
This site measures the concentration of $CO_2$ by funneling air through a cold chamber (to eliminate the effect of humidity) and then measuring how much infrared radiation is absorbed by the $CO_2$ in the chamber. Because $CO_2$ naturally absorbs infrared radiation, a higher density of $CO_2$ molecules will absorb more radiation. The researchers at the Mauna Loa site take great care to continually calibrate their equipment multiple times a day. In addition, the researchers are careful to account for any outside factors that may effect measurements such as the diurnal wind flow patterns present on Mauna Loa. Altogether, we can be confident that the data recorded at Mauna Loa is representative of global $CO_2$ concentrations.

```{r load the data}
co2_ts <- tsibble::as_tsibble(co2)

co2_df <- data.frame(index = 1:nrow(co2_ts),
                     month = factor(month(co2_ts$index)),
                     value = co2_ts$value)
```
\begin{figure}
    \centering\includegraphics[width=1\linewidth]{./figures/datamodels.png}
    \caption{Historic trend in monthly mean [$CO_2$]\label{fig:carbon}}
    \begin{figurenotes}
      $CO_2$ concentration exhibits accelerating growth, with strong seasonal oscillations. Polynomila models capture these trends to varying drgree.
    \end{figurenotes}
\end{figure}

# Exploratory analysis of historical trends in atmospheric $CO_{2}$

\par
\textcolor{red}{Description how, where and why the data is generated}
\par
\textcolor{red}{Investigate the trend, seasonal and irregular elements. Trends both in levels and growth rates should be discussed}
\par
\textcolor{blue}{Atmospheric carbon is plotted in \autoref{fig:carbon}, and shows some worrying trends. Just look at how wobbly that line is. How is it possible that we are not living in a simulation, when the lines that plots monthly average $CO_{2}$ looks like this?}
\par

# Models and Forecasts 
\textcolor{blue}{While these plots might be compelling, it is often challenging to learn the exact nature of a time serires process from only these overview, "time vs. outcome" style of plots. In this section, we present evaluate two classes models to assess which time series model is most appropriate to use. }

## Linear and Polynomial models 

\begin{wrapfigure}[28]{h}[0cm]{0.4\textwidth}\centering
    \vspace{-\normalbaselineskip}
    \includegraphics[width=0.45\textwidth,height=11\normalbaselineskip]{./figures/plot_lin_mod_resid.png}
    \caption{Diagnostic plots for residuals of the linear model\label{fig:lin_model_resid}}
    \bigskip
    \includegraphics[height=11\normalbaselineskip]{./figures/plot_quad_mod_resid.png}
    \caption{Diagnostic plots for residuals of the quadratic model\label{fig:quad_model_resid}}
\end{wrapfigure}

\begin{equation}
\label{eq:one}
\text{CO}_{2} = \phi_{0} + \phi_{1}t + \phi_{2}t^2 + \epsilon_{eit}
\end{equation} 

```{r estimate a linear model}
model_lin <- lm(formula = value ~ index, data = co2_df)
```

```{r linear model residuals, results='hide', echo=FALSE}
png(file = './figures/plot_lin_mod_resid.png', height=3, width=4, units = c("in"), res = 600)
checkresiduals(model_lin, test=FALSE, plot = TRUE)
dev.off()
```
\autoref{eq:one} is a general form of a polynomial model, where $CO_{2}$ concentration is modeled as a polynomial  function of time and a random error.\hfill\break\indent We first estimate the linear model, which is a variant of \autoref{eq:one} with $\phi_{2}=0$. While the residuals for this model appear to follow a normal distribution (\autoref{fig:lin_model_resid}), it is clear that a purely linear model does a poor job at modeling the seasonality of the data. There is also still clearly a trend in the remaining residuals which a linear model fails to capture. Overall, the a linear model does capture some of the trend but would not be sufficient to eliminate it entirely. \hfill\break\indent In attempt to remedy these issues we estimated a quadratic model, which is a variant of \autoref{eq:one} with all $\phi_{i}\neq0$:
```{r quadratic model}
model.quad <- lm(formula = value ~ index + I(index^2), data = co2_df)
```

```{r residuals for quad model, results='hide'}
png(file = './figures/plot_quad_mod_resid.png', height=3, width=4, units = c("in"), res = 600)
checkresiduals(model.quad, test=FALSE, plot = TRUE)
dev.off()
```
A quadratic model fares slightly better than a linear model. It captures inherent non-linearity of the trend (\autoref{fig:carbon}), but fails to capture seasonality. Diagnostic plots for this model ( \autoref{fig:quad_model_resid}) show that residuals are not normally distributed and ACF plot shows strong osculations. \hfill\break\indent There is not much evidence to support that a logarithmic transformation is necessary. \autoref{fig:decomp} shows that the seasonality factor is not multiplicative and the overall trend does not appear to be exponential.

```{r decompose, results='hide', warning=FALSE}
co2_decomp <- decompose(co2)

co2_df <- cbind(co2_df, co2_decomp$seasonal, co2_decomp$trend)

names(co2_df) = c("index", "month", "value", "seasonal", "trend")

trend <- ggplot(data = co2_df) + aes(x = index, y = trend ) + geom_line()
seasonal <- ggplot(data = co2_df) + aes(x = index, y = seasonal ) + geom_line()


png(file = './figures/plot_decomposition.png', height=3, width=3, units = c("in"), res = 600)
trend/seasonal
dev.off()
```
\begin{wrapfigure}[14]{l}{0.5\textwidth}
    \centering
    \vspace{-\normalbaselineskip}
    \includegraphics[height=11\normalbaselineskip]{./figures/plot_decomposition.png}
    \caption{Decomposition of the [$CO_2$] time series\label{fig:decomp}}
\end{wrapfigure} 

To address the issue of seasonality, we estimated a quadratic model augmented with the variable for the month:

```{r quadratic model w month variable}
model.wmonth <- lm(value ~ I(index^2) + index + month, data = co2_df)
```

```{r plot all models}
quad_plot <- co2_df %>%
ggplot() + aes(x = index, y = value) +
  geom_line(aes(y = fitted(model.wmonth), color = "Quadratic model + month"), size = 0.75) +
  geom_line(aes(y = fitted(model.quad), color = "Quadratic model"), size = 0.75) +
  geom_line(aes(y = fitted(model_lin), color = "Linear model"), size = 0.75) +
  geom_point(aes(color = "Observed data"), size = 0.5) +
  labs(x = 'Months since begining of measurements', y = TeX(r'(\[$CO_2$\], parts per million)')) +
  theme(axis.text.x=element_text(size=20), 
        axis.text.y=element_text(size=20), 
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20),
        ) +
  scale_color_manual(name = "", values = c("Observed data" = "black", 
                                           "Linear model" = "blue",
                                           "Quadratic model" = "green", 
                                           "Quadratic model + month" = "red" ))+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.position=c(.15,.85)) 


ggsave(filename = './figures/datamodels.png', plot = quad_plot, device = "png", units = c("in"), height= 4, width=8)
```

```{r residuals for model w month, results='hide'}
png(file = './figures/plot_wmonth_resid.png', height=4, width=5, units = c("in"), res = 600)
checkresiduals(model.wmonth, test=FALSE, plot = TRUE)
dev.off()
```

\begin{wrapfigure}[14]{l}{0.5\textwidth}
    \centering
    \vspace{-\normalbaselineskip}
    \includegraphics[height=11\normalbaselineskip]{./figures/plot_wmonth_resid.png}
     \caption{Diagnostic plots for quadratic model with month variable\label{fig:wmonth_resid}}
\end{wrapfigure} 
\autoref{fig:carbon} show that the use of monthly dummy variables is a marked improvement over the linear and quadratic models, although it does not entirely capture the seasonality the data. Nevertheless, \autoref{fig:wmonth_resid} reveal that residuals of this model, although close to normally distributed, are far from white noise. Gradually decaying ACF plot indicates substantial AR component in the residual series.

```{r forecasting using the wmonth model}
data.1997.max_month <- max(co2_df$index)
data.future.max_month <- data.1997.max_month + (12 * (2020 - 1997))
data.future <- data.frame(index = (data.1997.max_month + 1):data.future.max_month, month = factor(rep(1:12)))
model.wmonth.forecast <- predict.lm(model.wmonth, data.future, interval = "prediction", level = 0.95)
model.wmonth.predicted <- cbind(data.future, model.wmonth.forecast)

pred_plot <- ggplot() +
  geom_line(aes(x = index, y = value), color = 'black', data = co2_df) +
  geom_ribbon(aes(x = index, ymin = lwr, ymax = upr), fill = "yellow", alpha = 0.65, data = model.wmonth.predicted) +
  geom_line(aes(x = index, y = fit), color = 'red', data = model.wmonth.predicted) +
  labs(
    title = TeX(r'(Monthly Mean $CO_2$ with Forecasted Values)'),
    subtitle = 'Forecasted levels (with 95% CI) in blue',
    x = 'Months since Jan 1959',
    y = TeX(r'($CO_2$ parts per million)')
  )

ggsave(filename = "./figures/plot_wmonth_pred.png", plot = pred_plot, device = "png", units = c("in"), height = 4, width = 8)
```

\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot_wmonth_pred.png}
  \caption{Future [CO2], according to quadratic model w monthly variable\label{fig:wmonth_frcst}}
  \begin{figurenotes}
    Unrealistically narrow predication interval 
  \end{figurenotes}
\end{figure}

\autoref{fig:wmonth_frcst} demonstrates predictive capabilities of the model. While the 95% predictive interval does appear somewhat small for a forecast so far into the future, the predicted values reliably follow the pattern of the historical data.

## ARIMA times series model

\textcolor{red}{Following all appropriate steps, choose an ARIMA model to fit to the series. Discuss the characteristics of your model and how you selected between alternative ARIMA specifications. Use your model (or models) to generate forecasts to the year 2022. }

```{r Split into test and train, echo = TRUE, warning=FALSE}
my_lag <- 12
co2_ts <- mutate(co2_ts, deseasoned = difference(value, lag = my_lag))
co2_ts <- mutate(co2_ts, detrended = difference(deseasoned, lag = 1))
co2_ts <- slice(co2_ts, my_lag + 2:nrow(co2_ts))
```

```{r Explore model space}
# Generate a set of models AR(1)-AR(10) and MA(1)-MA(10)
# with first and second degree of differencing.
# Select the model with the lowest BIC

model.bic <- co2_ts %>%
  model(ARIMA(deseasoned ~ 1 + pdq(1:10, 1:2, 1:10) + PDQ(0, 0, 0),
    ic = "bic",
    stepwise = F, greedy = F
  ))

# Report the winning model parameters
model.bic %>% report()
```

```{r Make final model}
hist_arima <- arima(co2_ts$value,
  order = c(1, 1, 1),
  seasonal = list(order = c(0, 1, 1), period = 12)
)
hist_arima
```

```{r forecast to 2022}
frcst_length <- 300
frcst_2022 <- forecast(hist_arima, h=frcst_length)
```


```{r forecast plotting, results='hide'}
futuredate <- seq(ISOdate(1998,01,01), by = "month", length.out = frcst_length)

df_toPlot <- cbind.data.frame(futuredate, frcst_2022$mean, frcst_2022$lower, frcst_2022$upper)
df_toPlot$week <- yearweek(df_toPlot$futuredate)

df_toPlot <- df_toPlot[c(2,4,6,7)]
names(df_toPlot) <- c("mean", "lower", "upper", "date")

forecast_plot <- df_toPlot %>% ggplot() + 
  aes(x = date, y = mean) +
  geom_line(color = "red") + 
  geom_ribbon(aes(ymin=lower,ymax=upper), fill="yellow", alpha=0.35)

ggsave(filename = "./figures/plot1_frcst2022.pdf", plot = forecast_plot, device = "pdf", units = c("in"), height = 4, width = 10)
```


\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot1_frcst2022.pdf}
  \caption{Forecast for future CO2 concentration \label{fig:frcst2y}}
  \begin{figurenotes}
    Residuals appear to be white noise
  \end{figurenotes}
\end{figure}

## Forecast atmospheric $CO_{2}$ growth

\textcolor{red}{Generate predictions for when atmospheric CO2 is expected to be at 420 ppm and 500 ppm levels for the first and final times (consider prediction intervals as well as point estimates in your answer). Generate a prediction for atmospheric CO2 levels in the year 2100. How confident are you that these will be accurate predictions?}

# Conclusions 

\textcolor{red}{In this report we assessed data from the Mona Loa observatory to model and predict atmospheric $CO_{2}$ concentrations. Our modeling takes into account only observed  $CO_{2}$ data, with no attempt to bring into consideration other relevant information. Therefore the forecast from our modeling is only valid assuming all forces that currently influence atmospheric carbon remain unchanged. Given this reasobnable assumption, our model predicts a grim future for the global climate. }

\bibliographystyle{aea}
\bibliography{references}

\appendix
\section{Appendix: Model Robustness}

\textcolor{red}{While the most plausible model that we estimate is reported in the main, "Modeling" section, in this appendix to the article we examine alternative models. Here, our intent is to provide a skeptic that does not accept our assessment of this model as an ARIMA of order (1,2,3) an understanding of model forecasts under alternative scenarios. }
