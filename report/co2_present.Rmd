---
title: "Global $CO_{2}$ Emissions in 1997"
short: "What Keeling missed all these years"
journal: "AER" # AER, AEJ, PP, JEL
month: "`r format(Sys.Date(), '%m')`"
year: "`r format(Sys.Date(), '%Y')`"
vol: 0
issue: 0
keywords:
  - Replication
  - Modern Science
author:
  - name: Majid Maki-Nayeri
    firstname: Maki-Nayeri
    surname: Maki-Nayeri
    email: m_maki@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
  - name: Vinod Bakthavachalam
    firstname: Vinod
    surname: Bakthavachalam
    email: vinodb@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
  - name: Artem Lebedev
    firstname: Artem 
    surname: Lebedev
    email: artem.lebedev@berkeley.edu
    affiliation: McMaster University, Department of Chemistry and Biochemistry
acknowledgements: | 
  The authors would like to thank their instructors from MIDS 271.
abstract: | 
  One of the very interesting features of Keeling and colleagues’ research is that they were able to evaluate, and re-evaluate the data as new series of measurements were released. This permitted the evaluation of previous models’ performance and a much more difficult question: If their models’ predictions were “off” was this the result of a failure of the model, or a change in the system?
header-includes: 
  - '\usepackage{graphicx}'
  - '\usepackage{booktabs}'
  - '\usepackage{subcaption}'
output: rticles::aea_article
---

```{r setup, echo=FALSE}
## default to not show code, unless we ask for it.
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, dpi = 1000)
options(digits = 8)
```


```{r load packages, echo = FALSE, message = FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
library(dplyr)
library(magrittr)
library(patchwork)
library(lubridate)
library(feasts)
library(forecast)
library(sandwich)
if (!"fable" %in% rownames(installed.packages())) {
  install.packages("fable")
}
library(fable)
if (!"car" %in% rownames(installed.packages())) {
  install.packages("car")
}
library(car)
theme_set(theme_minimal())
```

# Introduction

\textcolor{red}{In this introduction, you can assume that your reader will have just read your 1997 report.} 

# Mona Loa $CO_{2}$ Data 
We first download data Create a data pipeline that starts by reading from the appropriate URL, and ends by saving an object called `co2_present` that is a suitable time series object. 

```{r data download, results='hide'}
url <- "https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_daily_mlo.csv" # URL
file_path <- "./data/raw_daily_data.csv" # Destination file
download.file(url, file_path, mode = "w")
```

```{r convert csv to tsibble}
# read csv into a dataframe
df <- read.table(file_path,
  sep = ",",
  dec = ".",
  numerals = c("no.loss"),
  skip = 48
)
# Rename columns for convenience
names(df) <- c("year", "month", "day", "date_dec", "ppm")
# Create date column
df$date <- make_datetime(
  year = df$year,
  month = df$month,
  day = df$day
)
# Drop unneeded columns
df <- df[5:6]

# Convert to tsibble
df <- df %>%
  mutate(date = as.Date(date)) %>%
  as_tsibble(index = "date")

# Aggregate by weeks:
co2_present <- df %>%
  index_by(week = ~ yearweek(.)) %>%
  summarise(ppm = mean(ppm))

# Fill missing values with the average of the nearest existing ones
co2_present <- co2_present %>%
  fill_gaps(.full = TRUE) %>%
  fill(ppm, .direction = "downup") %>%
  fill(ppm, .direction = "updown")
```


## Recent Trends in Atmospheric Carbon 
\textcolor{red}{Conduct the same EDA on this data. Describe how the Keeling Curve evolved from 1997 to the present, noting where the series seems to be following similar trends to the series that you "evaluated in 1997" and where the series seems to be following different trends. This EDA can use the same, or very similar tools and views as you provided in your 1997 report.}

Atmospheric carbon is plotted in \autoref{fig:carbon}, and shows relentless increase in atmospheric $CO_2$ concentration even at the remote Hawaiian island.

```{r plot the keeling curve}
fig_2_1 <- co2_present %>%
  ggplot() +
  aes(x = week, y = ppm) +
  geom_line(color = "steelblue") +
  labs(
    title = TeX(r'(Weekly Mean $CO_2$)'),
    subtitle = "Most recent measurements from Mona Loa station",
    x = "",
    y = TeX(r'(\[$CO_2$\], ppm)')
  )

ggsave(filename = "./figures/plot_2_1.pdf", plot = fig_2_1, device = "pdf", units = c("in"), height = 5, width = 10)
```

\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot_2_1.pdf}
  \caption{Recent trend in $CO_2$ concentration\label{fig:carbon}}
  \begin{figurenotes}
    $CO_2$ concentration from 1974 onward continues to exhibit ever accelerating growth, with strong seasonal oscillations. These patterns points to the need of de-seasoning and de-trending before further analysis.
  \end{figurenotes}
\end{figure} 

```{r EDA plots with de-trending}
my_lag <- 52
co2_present <- mutate(co2_present, deseasoned = difference(ppm, lag = my_lag))
co2_present <- mutate(co2_present, detrended = difference(deseasoned, lag = 1))
co2_diff <- slice(co2_present, my_lag + 2:nrow(co2_present))

diff_ts <- co2_diff %>%
  filter(week > yearweek("1998-01-01")) %>%
  ggplot() +
  aes(x = week, y = detrended) +
  geom_line() +
  labs(x = "", y = "Detrended TS")

acf_plot <- co2_diff %>%
  filter(week > yearweek("1998-01-01")) %>%
  ACF(detrended, type = "correlation") %>%
  autoplot() + labs(x = "lag", y = "ACF")

pacf_plot <- co2_diff %>%
  filter(week > yearweek("1998-01-01")) %>%
  ACF(detrended, type = "partial") %>%
  autoplot() + labs(x = "lag", y = "PACF")

ggsave(filename = "./figures/plot_2_2.pdf", plot = diff_ts, device = "pdf", units = c("in"), height = 4, width = 10)

ggsave(filename = "./figures/plot_2_3.pdf", plot = acf_plot, device = "pdf", units = c("in"), height = 4, width = 5)

ggsave(filename = "./figures/plot_2_4.pdf", plot = pacf_plot, device = "pdf", units = c("in"), height = 4, width = 5)
```

\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot_2_2.pdf}
  \caption{De-seasoned/-trended series for $CO_2$ concentration\label{fig:notrend_ts}}
\end{figure} 
\begin{figure}[h]
  \centering
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=\textwidth]{./figures/plot_2_3.pdf}
    \caption{Recent trend in $CO_2$ concentration\label{fig:notrend_acf}}
  \end{subfigure}
  \hfill
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=\textwidth]{./figures/plot_2_4.pdf}
    \caption{Recent trend in $CO_2$ concentration\label{fig:notrend_pacf}}
  \end{subfigure}
  \caption{Diagnostic plots for de-trended series\label{fig:notrend_plots}}
\end{figure}


# Models and Forecasts 
\textcolor{red}{While these plots might be compelling, it is often challenging to learn the exact nature of a time serires process from only these overview, "time vs. outcome" style of plots. In this section, we present evaluate two classes models to assess which time series model is most appropriate to use. }

## Linear Models 

\textcolor{red}{Descriptively compare realized atmospheric CO2 levels to those predicted by your forecast from a linear time model in 1997 (i.e. "Task 2a"). (You do not need to run any formal tests for this task.) }

## ARIMA Models 

\textcolor{red}{Descriptively compare realized atmospheric CO2 levels to those predicted by your forecast from the ARIMA model that you fitted in 1997 (i.e. "Task 3a"). Describe how the Keeling Curve evolved from 1997 to the present.}

## Performance of 1997 linear and ARIMA models 

\textcolor{red}{In 1997 you made predictions about the first time that CO2 would cross 420 ppm. How close were your models to the truth?}

\textcolor{red}{After reflecting on your performance on this threshold-prediction task, continue to use the weekly data to generate a month-average series from 1997 to the present, and compare the overall forecasting performance of your models from Parts 2a and 3b over the entire period. (You should conduct formal tests for this task.)}

## Best models on present data

\textcolor{red}{Seasonally adjust the weekly NOAA data, and split both seasonally-adjusted (SA) and non-seasonally-adjusted (NSA) series into training and test sets, using the last two years of observations as the test sets. For both SA and NSA series, fit ARIMA models using all appropriate steps. Measure and discuss how your models perform in-sample and (psuedo-) out-of-sample, comparing candidate models and explaining your choice. In addition, fit a polynomial time-trend model to the seasonally-adjusted series and compare its performance to that of your ARIMA model.}

```{r Split into test and train, echo = TRUE}
co2_train <- co2_diff %>% filter((week > yearweek("1998-01-01")) &
  (week < yearweek("2021-06-01")))

co2_test <- co2_diff %>% filter(week >= yearweek("2021-06-01"))
```

```{r Explore model space}
# Generate a set of models AR(1)-AR(10) and MA(1)-MA(10)
# with first and second degree of differencing.
# Select the model with the lowest BIC

model.bic <- co2_train %>%
  model(ARIMA(deseasoned ~ 1 + pdq(1:10, 1:2, 1:10) + PDQ(0, 0, 0),
    ic = "bic",
    stepwise = F, greedy = F
  ))

# Report the winning model parameters
# model.bic %>% report()
```

```{r Make final model}
final_arima <- arima(co2_train$ppm,
  order = c(1, 1, 2),
  seasonal = list(order = c(0, 1, 1), period = 52)
)
final_arima
```

```{r Test residuals}
# Visualize ACF plot of its residuals
resid_acf_plot <- final_arima %>%
  residuals() %>%
  acf(plot = FALSE) %>%
  autoplot() + coord_cartesian(xlim = c(1, 20))
ggsave(filename = "./figures/plot_2_5.pdf", plot = resid_acf_plot, device = "pdf", units = c("in"), height = 4, width = 10)
```

\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot_2_5.pdf}
  \caption{ACF plot for SARIMA(1.1.1)(0.1.1)[52] residuals \label{fig:resid_acf}}
  \begin{figurenotes}
    Residuals appear to be white noise
  \end{figurenotes}
\end{figure} 

## Forecasts: How bad could it get?

\textcolor{red}{With the non-seasonally adjusted data series, generate predictions for when atmospheric CO2 is expected to be at 420 ppm and 500 ppm levels for the first and final times (consider prediction intervals as well as point estimates in your answer). Generate a prediction for atmospheric CO2 levels in the year 2122. How confident are you that these will be accurate predictions?}

\textcolor{red}{Because we have fitted a model, we can make predictions from that model. Our preferred model, named in is quite simple, and as you might notice, does not in fact match up with the model that we have fitted.}

# Conclusions 

\textcolor{red}{What to conclude is unclear. }

\bibliographystyle{aea}
\bibliography{references}

\appendix
\section{Appendix: Model Robustness}

\textcolor{red}{While the most plausible model that we estimate is reported in the main, "Modeling" section, in this appendix to the article we examine alternative models. Here, our intent is to provide a skeptic that does not accept our assessment of this model as an ARIMA of order (1,2,3) an understanding of model forecasts under alternative scenarios. }
