---
title: "Global $CO_{2}$ Emissions in 2023 and beyond"
short: "What Keeling missed all these years"
journal: "AER" # AER, AEJ, PP, JEL
month: "`r format(Sys.Date(), '%m')`"
year: "`r format(Sys.Date(), '%Y')`"
author: ""
vol: 0
issue: 0
header-includes: 
  - '\author{}'
  - '\usepackage{graphicx}'
  - '\usepackage{booktabs}'
  - '\usepackage{wrapfig}'
  - '\usepackage{subcaption}'
output: rticles::aea_article
---

```{r setup, echo=FALSE}
## default to not show code, unless we ask for it.
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, dpi = 1000)
options(digits = 8)
```


```{r load packages, echo = FALSE, message = FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
library(dplyr)
library(magrittr)
library(patchwork)
library(lubridate)
library(feasts)
library(forecast)
library(sandwich)
if (!"fable" %in% rownames(installed.packages())) {
  install.packages("fable")
}
library(fable)
if (!"car" %in% rownames(installed.packages())) {
  install.packages("car")
}
library(car)
theme_set(theme_minimal())
```
\renewcommand{\columnsep}{10pt}
# Introduction

\textcolor{black}{In this report, we are making predictions on global CO2 emissions in 2023 and beyond to raise awareness of the ever-increasing CO2 emissions globally.} 

# Mona Loa $CO_{2}$ Data 
We first download a data pipeline that starts by reading from the appropriate URL and ends by saving an object called `co2_present`, a suitable time series object. 

```{r data download, results='hide'}
url <- "https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_daily_mlo.csv" # URL
file_path <- "./data/raw_daily_data.csv" # Destination file
download.file(url, file_path, mode = "w")
```

```{r convert csv to tsibble}
# read csv into a dataframe
df <- read.table(file_path,
  sep = ",",
  dec = ".",
  numerals = c("no.loss"),
  skip = 48
)
# Rename columns for convenience
names(df) <- c("year", "month", "day", "date_dec", "ppm")
# Create date column
df$date <- make_datetime(
  year = df$year,
  month = df$month,
  day = df$day
)
# Drop unneeded columns
df <- df[5:6]

# Convert to tsibble
df <- df %>%
  mutate(date = as.Date(date)) %>%
  as_tsibble(index = "date")

# Aggregate by weeks:
co2_present <- df %>%
  index_by(week = ~ yearweek(.)) %>%
  summarise(ppm = mean(ppm))

# Fill missing values with the average of the nearest existing ones
co2_present <- co2_present %>%
  fill_gaps(.full = TRUE) %>%
  fill(ppm, .direction = "downup") %>%
  fill(ppm, .direction = "updown")

# Create df we will need for plotting
co2_present_df <- data_frame(co2_present)
co2_present_df <- co2_present_df %>%
  mutate(my_date = as.Date(co2_present_df$week))
```


## Recent Trends in Atmospheric Carbon 
\textcolor{red}{After 1997, CO2 emission level continues to rise at a steady pace. More troublsome is the increasing slope of CO2 emissions level. In fact, the CO2 emissions level is rising at a higher rate between 2010 and now than the period before 1996, as demosntrated by the steepening slope in the chart below. In general, the trend is similar to the trend obsered before 1996: steady uptrend. However, the rate is becoming higher, and all of our forecast models seem to underestimate the CO2 emissions level.}

Atmospheric carbon is plotted in \autoref{fig:carbon}, and shows relentless increase in atmospheric $CO_2$ concentration even at the remote Hawaiian island.

```{r read objects from 1997 report}
co2_df <- readRDS("co2_df.df")
df_frcst <- readRDS("df_frcst.df")
df_frcst_polynom <- readRDS("df_frcst_polynom.df")

tail(co2_present_df,100)
```

```{r plot the keeling curve}
ts_and_forecast <- ggplot() + 
  geom_line(aes(x = my_date, y = ppm, color = "Observed data"), data = co2_present_df) +
  geom_line(aes(x = my_date, y = mean, color = "SARIMA(1.2.1)(0.1.1)"), data = df_frcst) + 
  geom_line(aes(x = my_date, y = pred_quad, color = "Quadratic model w month"), data = df_frcst_polynom) +
  geom_line(aes(x = my_date, y = pred_lin, color = "Linear model"), data = df_frcst_polynom) +
  labs(x = element_blank(), y = TeX(r'(\[$CO_2$\], ppm)')) + 
  xlim (as.Date("1980-01-01"), as.Date("2025-01-01")) + ylim(325, 425) +

  scale_color_manual(name = "", values = c("Observed data" = "black", 
                                         "Quadratic model w month" = "darkgreen",
                                         "SARIMA(1.2.1)(0.1.1)" = "red",
                                          "Linear model" = "blue")) +
  # Legend text and position
  theme(legend.position=c(.25,.85),
        legend.text=element_text(size=20)) +
  # Axis text
  theme(axis.text.x=element_text(size=20), 
        axis.text.y=element_text(size=20), 
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20)) +
  # Lines
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank())

ggsave(filename = "./figures/plot2_ts.png", plot = ts_and_forecast, device = "png", units = c("in"), height = 5, width = 10)

```


\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot2_ts.png}
  \caption{Recent trend in $CO_2$ concentration\label{fig:OldModels}}
  \begin{figurenotes}
    $CO_2$ concentration from 1974 onward continues to exhibit ever accelerating growth, with strong seasonal oscillations. These patterns points to the need of de-seasoning and de-trending before further analysis.
  \end{figurenotes}
\end{figure} 

```{r EDA plots with de-trending}
my_lag <- 52
co2_present <- mutate(co2_present, deseasoned = difference(ppm, lag = my_lag))
co2_present <- mutate(co2_present, detrended = difference(deseasoned, lag = 1))
co2_diff <- slice(co2_present, my_lag + 2:nrow(co2_present))

diff_ts <- co2_diff %>%
  filter(week > yearweek("1998-01-01")) %>%
  ggplot() +
  aes(x = week, y = detrended) +
  geom_line() +
  labs(x = "", y = "Detrended TS")

acf_plot <- co2_diff %>%
  filter(week > yearweek("1998-01-01")) %>%
  ACF(detrended, type = "correlation") %>%
  autoplot() + labs(x = "lag", y = "ACF")

pacf_plot <- co2_diff %>%
  filter(week > yearweek("1998-01-01")) %>%
  ACF(detrended, type = "partial") %>%
  autoplot() + labs(x = "lag", y = "PACF")

ggsave(filename = "./figures/plot_2_2.pdf", plot = diff_ts, device = "pdf", units = c("in"), height = 4, width = 10)

ggsave(filename = "./figures/plot_2_3.pdf", plot = acf_plot, device = "pdf", units = c("in"), height = 4, width = 5)

ggsave(filename = "./figures/plot_2_4.pdf", plot = pacf_plot, device = "pdf", units = c("in"), height = 4, width = 5)
```

\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot_2_2.pdf}
  \caption{De-seasoned/-trended series for $CO_2$ concentration\label{fig:notrend_ts}}
\end{figure} 
\begin{figure}[h]
  \centering
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=\textwidth]{./figures/plot_2_3.pdf}
    \caption{Recent trend in $CO_2$ concentration\label{fig:notrend_acf}}
  \end{subfigure}
  \hfill
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=\textwidth]{./figures/plot_2_4.pdf}
    \caption{Recent trend in $CO_2$ concentration\label{fig:notrend_pacf}}
  \end{subfigure}
  \caption{Diagnostic plots for de-trended series\label{fig:notrend_plots}}
\end{figure}


# Models and Forecasts 
\textcolor{red}{While these plots might be compelling, it is often challenging to learn the exact nature of a time serires process from only these overview, "time vs. outcome" style of plots. In this section, we present and evaluate two classes models to assess which time series model is most appropriate to use. }

## 1997 Models vs realized data 
\autoref{fig:OldModels} demonstrates the recent trends in [$CO_{2}$] along with the models fitted on the data prior to 1997. It is clear that ever accelerating trend continues, with no noticeable slow down or even reduced acceleration. The linear model significantly underestimates the real concentration. Remarkably, simple quadratic model augmented with months as categories is extremely accurate, capturing both accelerating trend and seasonal variability 25 years into the future. Our best ARIMA model underestimates real observations only slightly and its performance is still unexpectedly good for predictions that far out. It is worth noting that both seasonal models perform extremely well up until approximately 2016, when the real trend seemed to have had an additional boost. Then ARIMA model started falling behind at an increasing rate. That might be a statistical fluke, or might indicate the change in the $CO_{2}$ emissions. 

## Performance of 1997 linear and ARIMA models 

\textcolor{black}{In 1997, we predicted that CO2 would cross 420 ppm for the first time in April 2023, with the earliest possible date being May 2015. The observed data shows that CO2 emission level first reached 420 in February 2022. Our predictions were actually quite close to the observed date, with our average expected date only 1 year off from the actual date. In fact, February 2022 falls within the range of our forecast (mean April 2023, lower bound(earliest) May 2015).


## Best models on present data

In this section we will compare performance of various models in terms of their predictive power. For that we will save a small portion of our data, the most recent 2 years, as a test set. We will use the rest of the data (train set) to generate the models.
```{r Split into test and train, echo = TRUE}
# Create a training set
co2_train <- co2_diff %>% filter((week > yearweek("1998-01-01")) &
  (week < yearweek("2021-06-01")))

# Cretae a test set
co2_test <- co2_diff %>% filter(week >= yearweek("2021-06-01"))
```

We first focus on seasonally adjusted data. As a first step we will perform a grid search of the model space, looking for the ARIMA model with the lowest BIC.
```{r Explore model space}
model.nsa <- co2_train %>%
  model(ARIMA(deseasoned ~ 1 + pdq(1:10, 1:2, 1:10) + PDQ(0, 0, 0),
    ic = "bic",
    stepwise = F, greedy = F
  ))

model.nsa %>% report() # Report the winning model parameters
```


```{r Make final model}
final_arima <- arima(co2_train$ppm,
  order = c(1, 1, 2),
  seasonal = list(order = c(0, 1, 1), period = 52)
)
final_arima
```


```{r Test residuals}
# Visualize ACF plot of its residuals
resid_acf_plot <- final_arima %>%
  residuals() %>%
  acf(plot = FALSE) %>%
  autoplot() + coord_cartesian(xlim = c(1, 20))
ggsave(filename = "./figures/plot_2_5.pdf", plot = resid_acf_plot, device = "pdf", units = c("in"), height = 4, width = 10)
resid_acf_plot
```

\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot_2_5.pdf}
  \caption{ACF plot for SARIMA(1.1.1)(0.1.1)[52] residuals \label{fig:resid_acf}}
  \begin{figurenotes}
    Residuals appear to be white noise
  \end{figurenotes}
\end{figure} 

## Forecasts: How bad could it get?

\textcolor{black}{With the non-seasonally adjusted data series, we predict that atmospheric CO2 is expected to be at 420 ppm in April 2022 on average, and at 500 ppm for the first time in January 2045 (1225 weeks) the earlist,  February 2056 (1810 weeks from June 2021) on average. Based on our models, we also predict that atmospheric CO2 levels will reach 655 ppm with an 80% confidence interval of [524,785] in January 2122. Since 2122 is almost 100 years away from now, we do not have high confidence, as our 80% confidence interval is already 250 ppm wide. Also, given the rising awareness of the global warming crisis, policy measures might be introduced in the next few decades to arrest the accelerating trend of CO2 emission increases. Our prediction is only valid if no exogenous factors are introduced in the next century and that we maintain the status quo. Positive and negative shock can happen as a result of natural disasters, wars, clean-energy policies, etc. Therefore we do not have high confidence. The numbers are our best guess from the statistical model we have currently.

```{r Forecast, results='hide'}
frcst_length <- 110
forecast_data <- forecast(final_arima, h = frcst_length)

```
```{r}
options(max.print = 10000)   
frcst_length2 <- (2122-2021)* 52 -12
forecast_data2 <- forecast(final_arima, h = frcst_length2)

```



```{r Forecast plotting}
futuredate <- seq(ISOdate(2021, 06, 01), by = "week", length.out = frcst_length)

df_toPlot <- cbind.data.frame(futuredate, forecast_data$mean, forecast_data$lower, forecast_data$upper)
df_toPlot$week <- yearweek(df_toPlot$futuredate)

df_toPlot <- df_toPlot[c(2, 4, 6, 7)]
names(df_toPlot) <- c("mean", "lower", "upper", "date")

forecast_plot <- df_toPlot %>% ggplot() +
  aes(x = date, y = mean) +
  geom_line(color = "red") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "yellow", alpha = 0.25) +
  geom_line(data = co2_test, aes(x = week, y = ppm))

ggsave(filename = "./figures/plot_2_6.pdf", plot = forecast_plot, device = "pdf", units = c("in"), height = 4, width = 10)
forecast_plot
```

\begin{figure}[ht]
  \includegraphics[width=.8\linewidth]{./figures/plot_2_6.pdf}
  \caption{Forecast for future CO2 concentration \label{fig:frcst2y}}
  \begin{figurenotes}
    Residuals appear to be white noise
  \end{figurenotes}
\end{figure}


# Conclusions 

\textcolor{black}{In this report, we assessed data from the Mona Loa observatory to model and
predict atmospheric CO2 concentrations for the next century. Compared to the last report, we have access to present data, which improves our predictive power. The forecast from our modeling is only valid assuming all
forces that currently influence atmospheric carbon remain unchanged. Given this
reasonable assumption, our model still predicts a very grim future for the global climate if no actions are taken. In fact, our predictions are fairly close to the last report, which indicates that nothing has been done to stop the trend. The global CO2 level will reach a whopping 655 ppm in 2122 based on 
our forecast, making the planet uninhabitable.}

\bibliographystyle{aea}
\bibliography{references}

\appendix
\section{Appendix: Model Robustness}

\textcolor{red}{While the most plausible model that we estimate is reported in the main, "Modeling" section, in this appendix to the article we examine alternative models. Here, our intent is to provide a skeptic that does not accept our assessment of this model as an ARIMA of order (1,2,3) an understanding of model forecasts under alternative scenarios. }
